apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: sciety--demo
spec:
  releaseName: sciety--demo
  interval: 5m
  chart:
    spec:
      chart: helm/sciety
      reconcileStrategy: Revision
      sourceRef:
        kind: GitRepository
        name: sciety
      interval: 1m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  valuesFrom:
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: CROSSREF_API_BEARER_TOKEN
      targetPath: crossrefApiBearerToken
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: SCIETY_TEAM_API_BEARER_TOKEN
      targetPath: ingestionAuthBearerToken
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: APP_SECRET
      targetPath: appSecret
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: AUTH0_CLIENT_ID
      targetPath: auth0ClientId
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: AUTH0_CLIENT_SECRET
      targetPath: auth0ClientSecret
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: AUTH0_DOMAIN
      targetPath: auth0Domain
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: AUTH0_CALLBACK_URL
      targetPath: auth0CallbackUrl
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: PRELIGHTS_FEED_KEY
      targetPath: prelightsFeedKey
    - kind: Secret
      name: sciety--demo--secret-env-vars
      valuesKey: healthchecksPingKey
      targetPath: healthchecksPingKey
    - kind: ConfigMap
      name: sciety--demo--public-env-vars
      valuesKey: EXPERIMENT_ENABLED
      targetPath: experimentEnabled
    - kind: ConfigMap
      name: sciety--demo--public-env-vars
      valuesKey: APP_CACHE
      targetPath: appCache
    - kind: ConfigMap
      name: sciety--demo--public-env-vars
      valuesKey: GOOGLE_TAG_MANAGER_ID
      targetPath: googleTagManagerId
  values:
    hostname: sciety-demo.elifesciences.org
    images:
      frontend:
        tag: 52778c18053202bef63ab2ba04dc872667d316b6
    enableEventsExportToS3: "true"
    certManagerClusterIssuer: letsencrypt-prod
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: CronJob
              name: sciety--demo--export-events
            patch: |
              - op: remove
                path: /spec/jobTemplate/spec/template/spec/containers/0/env
              - op: replace
                path: /spec/suspend
                value: true
